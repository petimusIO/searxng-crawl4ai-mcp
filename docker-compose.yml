# SearXNG + Crawl4AI MCP - Truly Self-Hosted Search & Scrape Stack

services:
  # SearXNG - Open source metasearch engine
  searxng:
    image: searxng/searxng:latest
    container_name: searxng
    ports:
      - "8081:8080"
    environment:
      - SEARXNG_BASE_URL=http://localhost:8081/
      - SEARXNG_SECRET=${SEARXNG_SECRET:-$(openssl rand -hex 32)}
    volumes:
      - ./searxng-settings.yml:/etc/searxng/settings.yml:ro
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - DAC_OVERRIDE
    networks:
      - search-net
    restart: unless-stopped
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8080/ || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis for caching
  redis:
    image: redis:alpine
    command: redis-server --save 30 1 --loglevel warning
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    networks:
      - search-net
    restart: unless-stopped
    healthcheck:
      test: redis-cli ping
      interval: 10s
      timeout: 3s
      retries: 3

  # Crawl4AI service for web scraping
  crawl4ai:
    build:
      context: .
      dockerfile: Dockerfile.crawl4ai
    container_name: crawl4ai
    ports:
      - "8001:8000"
    environment:
      - PROXY_URL=${PROXY_URL}
      - CRAWL4AI_LOG_LEVEL=INFO
    networks:
      - search-net
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./logs:/app/logs

  # Our MCP Server (orchestrates SearXNG + Crawl4AI)
  mcp-server:
    build: 
      context: .
      dockerfile: Dockerfile
    ports:
      - "3003:3003"
    environment:
      - SEARXNG_URL=http://searxng:8080
      - CRAWL4AI_URL=http://crawl4ai:8000
      - PROXY_URL=${PROXY_URL}
      - LOG_LEVEL=info
      - MCP_HTTP_PORT=3003
      - MCP_SSE_PORT=3003  # legacy/alias for SSE path
      - MCP_INTERNAL_TOKEN=${MCP_INTERNAL_TOKEN:-}  # set a strong token in production (do NOT commit)
    depends_on:
      searxng:
        condition: service_healthy
      crawl4ai:
        condition: service_started
    networks:
      - search-net
      - coolify   # connect to external Coolify network so MCP can be reached by other services
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped

volumes:
  redis_data:

networks:
  search-net:
    driver: bridge
  coolify:
    external: true